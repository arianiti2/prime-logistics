<div class="flex h-full bg-slate-50 overflow-hidden">
  <!-- Sidebar -->
  <aside class="w-80 bg-white border-r border-slate-200 flex flex-col shrink-0">
    <div class="p-4 border-b">
      <h2 class="text-lg font-bold mb-4 text-slate-800">Logistics Network</h2>
      <div class="relative">
        <div class="flex items-center gap-0 max-w-md bg-white border border-slate-200 rounded-xl shadow-sm focus-within:ring-2 focus-within:ring-indigo-500/20 focus-within:border-indigo-500 transition-all p-1.5">
          <div class="pl-3 pr-2 text-slate-400">
            <svg xmlns="http://www.w3.org" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>

          <input 
            [(ngModel)]="emailSearch"
            (focus)="onEmailInputFocus()"
            (blur)="onEmailInputBlur()"
            (ngModelChange)="onEmailSearchChange()"
            (keyup.enter)="sendRequest()"
            placeholder="Search and invite by email..."
            class="flex-1 text-sm bg-transparent outline-none py-1.5 pr-2 placeholder:text-slate-400"
          >
        </div>

        @if (showEmailSuggestions()) {
          <div class="absolute left-0 right-0 mt-2 bg-white border border-slate-200 rounded-xl shadow-lg z-20 overflow-hidden">
            <div class="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider border-b bg-slate-50">Available Emails</div>
            <div class="max-h-52 overflow-y-auto">
              @for (email of filteredEmails(); track email) {
                <div class="flex items-center justify-between gap-3 px-3 py-2.5 border-b last:border-b-0 border-slate-100 hover:bg-slate-50 transition-colors">
                  <p class="text-sm text-slate-700 truncate">{{ email }}</p>
                  <button
                    type="button"
                    (mousedown)="$event.preventDefault(); sendRequest(email)"
                    class="bg-emerald-600 text-white px-2.5 py-1 rounded-md text-[10px] font-bold hover:bg-emerald-700 active:scale-95 transition-all"
                  >
                    Add
                  </button>
                </div>
              } @empty {
                <p class="px-3 py-3 text-xs text-slate-400">No emails match your search.</p>
              }
            </div>
          </div>
        }
      </div>

    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar">
      <!-- Incoming Requests -->
      @if (pendingRequests().length > 0) {
        <div class="p-4 bg-amber-50 border-b border-amber-100">
          <h3 class="text-[10px] font-bold text-amber-700 uppercase mb-2 tracking-wider">Pending Requests</h3>
          @for (req of pendingRequests(); track req._id) {
            <div class="bg-white p-2 rounded-lg border border-amber-200 mb-2 shadow-sm">
              <p class="text-xs font-bold text-slate-800">{{ req.requester?.name }}</p>
              <p class="text-[10px] text-slate-500 truncate">{{ req.requester?.email }}</p>
              <button (click)="acceptFriendRequest(req._id)" class="w-full mt-2 py-1.5 bg-indigo-600 text-white text-[10px] font-bold rounded-md hover:bg-indigo-700 transition-all">Accept Connection</button>
            </div>
          }
        </div>
      }

      <div class="py-2">
        <h3 class="px-4 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Active Contacts</h3>
        @for (friend of friendsList(); track friend._id) {
          <div (click)="activeChat.set(friend)" 
               [class.bg-indigo-50]="activeChat()?._id === friend._id"
               class="px-4 py-3 hover:bg-slate-50 cursor-pointer flex items-center gap-3 transition-colors border-l-4 border-transparent"
               [class.border-indigo-500]="activeChat()?._id === friend._id">
            <div class="w-9 h-9 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs shrink-0">
              {{ friend.name.charAt(0) }}
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-bold text-slate-800 truncate">{{ friend.name }}</p>
              <p class="text-[10px] text-slate-500 capitalize">{{ friend.role }}</p>
            </div>
          </div>
        } @empty {
          <p class="px-4 py-4 text-xs text-slate-400 italic">No contacts added yet.</p>
        }
      </div>
    </div>
  </aside>

  <!-- Chat Window -->
  <main class="flex-1 flex flex-col bg-white">
    @if (activeChat()) {
      <header class="h-16 border-b px-6 flex items-center justify-between bg-white/80 backdrop-blur-sm sticky top-0 z-10">
        <div>
          <h2 class="text-sm font-bold text-slate-800">{{ activeChat().name }}</h2>
          
          <!-- TYPING INDICATOR -->
          @if (isFriendTyping()) {
            <p class="text-[10px] text-indigo-500 font-bold animate-pulse">is typing...</p>
          } @else {
            <p class="text-[10px] text-green-500 font-medium">Online</p>
          }
        </div>
      </header>
      
      <!-- SCROLL CONTAINER -->
      <div #scrollContainer class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 bg-slate-50/50 scroll-smooth">
        @for (msg of filteredMessages(); track $index) {
          <div [class]="msg.senderId === currentUser._id ? 'items-end' : 'items-start'" class="flex flex-col">
            <div [class]="msg.senderId === currentUser._id ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-none' : 'bg-white border border-slate-200 text-slate-700 rounded-2xl rounded-tl-none shadow-sm'"
                 class="max-w-[70%] p-3.5 text-sm leading-relaxed">
              {{ msg.text }}
            </div>
            <span class="text-[9px] text-slate-400 mt-1 font-bold uppercase tracking-tighter">
                {{ (msg.createdAt || msg.timestamp) | date:'shortTime' }}
            </span>
          </div>
        }
      </div>

      <footer class="p-4 border-t bg-white">
        <div class="flex gap-3 max-w-5xl mx-auto">
          <input 
            [(ngModel)]="newMessage" 
            (input)="onTyping()"
            (keyup.enter)="sendMessage()" 
            placeholder="Write your logistics update..." 
            class="flex-1 p-3.5 bg-slate-100 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all">
          
          <button 
            (click)="sendMessage()" 
            [disabled]="!newMessage.trim()"
            class="bg-indigo-600 disabled:opacity-50 text-white px-6 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all">
            Send
          </button>
        </div>
      </footer>
    } @else {
      <div class="flex-1 flex flex-col items-center justify-center bg-slate-50">
        <div class="w-16 h-16 bg-white rounded-2xl shadow-xl flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
        </div>
        <h3 class="text-slate-800 font-bold">Select a contact</h3>
        <p class="text-slate-400 text-xs mt-1">Pick a logistics partner from the list to start coordinating.</p>
      </div>
    }
  </main>
</div>
